<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltage Tuning Exercise - Phase 2 (5-Bus System)</title>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div>
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; text-align: center; font-size: 1.2rem; font-weight: 500;">Loading Voltage Tuning Exercise...</p>
            
            <!-- Progress Steps -->
            <div id="loading-steps" style="margin: 2rem 0; text-align: center;">
                <div class="loading-step" id="step-pyodide">
                    <span class="step-icon">⏳</span> Loading Pyodide Runtime
                </div>
                <div class="loading-step" id="step-numpy">
                    <span class="step-icon">⏳</span> Loading NumPy
                </div>
                <div class="loading-step" id="step-charts">
                    <span class="step-icon">⏳</span> Initializing Charts
                </div>
                <div class="loading-step" id="step-python">
                    <span class="step-icon">⏳</span> Loading Python Modules
                </div>
                <div class="loading-step" id="step-simulation">
                    <span class="step-icon">⏳</span> Setting up Simulation
                </div>
            </div>
            
            <!-- Status and Progress -->
            <p id="loading-status" style="text-align: center; color: var(--text-muted); margin-bottom: 0.5rem;">Initializing...</p>
            <p id="loading-detail" style="text-align: center; color: var(--text-muted); font-size: 0.9rem; min-height: 1.2em;">First load typically takes 5-10 seconds</p>
            
            <!-- Progress Bar -->
            <div style="width: 300px; margin: 1rem auto; background: var(--border-color, #ddd); border-radius: 10px; height: 8px;">
                <div id="loading-progress" style="width: 0%; background: var(--primary-color, #3498db); height: 100%; border-radius: 10px; transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <div class="header-buttons">
                <button id="panel-toggle" class="panel-toggle-btn" title="Toggle control panels">
                    <div class="hamburger-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <button id="keyboard-shortcuts-btn" class="keyboard-shortcuts-btn" title="Show keyboard shortcuts">
                    <div class="keyboard-icon">⌨️</div>
                </button>
            </div>
            <h1 style="margin: 0;">Voltage Tuning Exercise: <span class="header-description">Real-time Voltage Control and Power Flow Simulation</span></h1>
        </div>

        <div class="main-grid">
            <!-- Controls Container -->
            <div class="controls-container">
                <!-- Simulation Control Panel -->
                <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleSimulationControlPanel()">
                        Simulation Control
                        <span id="simulation-control-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="simulation-control-content">
                    <div class="simulation-controls" style="display: flex; justify-content: space-between; gap: 4px;">
                        <button id="start-simulation" title="Start simulation (Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--success-color, #27ae60); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Start</button>
                        <button id="stop-simulation" title="Stop simulation (Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--danger-color, #e74c3c); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Stop</button>
                        <button id="reset-simulation" title="Reset simulation (Shift+Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--warning-color, #f39c12); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Reset</button>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Tuning Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleTuningPanel()">
                        Tuning
                        <span id="tuning-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="tuning-content">
                        <div class="config-item">
                            <label>Proportional Gain:</label>
                            <input type="number" id="voltage-kp" value="10.0" min="1.0" max="50.0" step="1.0">
                        </div>
                        <div class="config-item">
                            <label>Integral Gain:</label>
                            <input type="number" id="voltage-ki" value="50.0" min="1.0" max="200.0" step="1.0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Voltage Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleVoltageControlPanel()">
                        Voltage Control
                        <span id="voltage-control-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="voltage-control-content" class="voltage-control">
                        <div class="voltage-display">
                            <span id="voltage-display">100.0</span> %
                        </div>
                        <div class="voltage-slider-container">
                            <button id="voltage-down-large" class="voltage-button" title="Decrease voltage reference by 2%">▼▼</button>
                            <button id="voltage-down" class="voltage-button" title="Decrease voltage reference">▼</button>
                            <input type="range" id="voltage-slider" class="voltage-slider" 
                                   min="90" max="110" value="100" step="0.1" list="voltage-ticks">
                            <datalist id="voltage-ticks">
                                <option value="90"></option>
                                <option value="100"></option>
                                <option value="110"></option>
                            </datalist>
                            <button id="voltage-up" class="voltage-button" title="Increase voltage reference">▲</button>
                            <button id="voltage-up-large" class="voltage-button" title="Increase voltage reference by 2%">▲▲</button>
                        </div>
                        <div class="voltage-range-labels">
                            <span>90%</span>
                            <span>110%</span>
                        </div>
                        <div class="voltage-adjustments">
                            <div class="config-item">
                                <label>Coarse Adjust (%):</label>
                                <input type="number" id="coarse-adjust" value="3.0" min="0.1" max="10.0" step="0.5">
                            </div>
                            <div class="config-item">
                                <label>Fine Adjust (%):</label>
                                <input type="number" id="fine-adjust" value="0.5" min="0.1" max="5.0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Parameters Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleSystemParametersPanel()">
                        System Parameters
                        <span id="system-parameters-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="system-parameters-content">
                    <div class="config-item">
                        <label>Update Rate (ms):</label>
                        <input type="number" id="update-rate" value="10" min="10" max="1000" step="10">
                    </div>
                    <div class="config-item">
                        <label>Noise Level (%):</label>
                        <input type="number" id="noise-level" value="0.2" min="0" max="5.0" step="0.1">
                    </div>
                    <div class="config-item">
                        <label>System Reactance (pu):</label>
                        <input type="number" id="system-reactance" value="0.05" min="0.01" max="0.2" step="0.01">
                    </div>
                    <div class="config-item">
                        <label>Plant Time Constant (s):</label>
                        <input type="number" id="plant-time-constant" value="0.25" min="0.1" max="2.0" step="0.05">
                    </div>
                    </div>
                </div>
            </div>
            
                <!-- Chart Configurations Panel -->
                <div class="control-panel">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleChartConfigPanel()">
                        Chart Configurations
                        <span id="chart-config-toggle" style="font-size: 0.8rem; opacity: 0.7;">▶</span>
                    </h3>
                    <div id="chart-config-content" class="collapsed">
                        <div class="chart-controls" style="margin-top: 0.3rem;">
                            <button id="reset-chart-scales" style="width: 100%; padding: 0.35rem; background: var(--secondary-color, #3498db); color: white; border: none; border-radius: 0.2rem; cursor: pointer; font-size: 0.8rem; margin-bottom: 0.5rem;">
                                Reset Chart Scales
                            </button>
                            
                            <div class="chart-option" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
                                <input type="checkbox" id="chart-expansion" checked style="margin-right: 0.5rem;">
                                <label for="chart-expansion" style="font-size: 0.8rem; color: var(--text-color); cursor: pointer;">Chart Expansion</label>
                            </div>
                            
                            <div class="chart-option" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
                                <input type="checkbox" id="chart-contraction" checked style="margin-right: 0.5rem;">
                                <label for="chart-contraction" style="font-size: 0.8rem; color: var(--text-color); cursor: pointer;">Chart Contraction</label>
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Tail Buffer (s):</label>
                                <input type="number" id="tail-buffer" value="0.5" min="0" max="10" step="0.1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Total Chart Time (s):</label>
                                <input type="number" id="total-chart-time" value="15" min="5" max="50" step="1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Head Buffer (s):</label>
                                <input type="number" id="head-buffer" value="1" min="0" max="5" step="0.1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Line Width:</label>
                                <input type="number" id="line-width" value="1.5" min="0.5" max="10" step="0.5" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Reference Color:</label>
                                <input type="color" id="reference-color" value="#e74c3c" style="width: 60px; padding: 0.1rem; border: 1px solid var(--border-color); border-radius: 0.2rem; cursor: pointer;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Actual Color:</label>
                                <input type="color" id="actual-color" value="#3498db" style="width: 60px; padding: 0.1rem; border: 1px solid var(--border-color); border-radius: 0.2rem; cursor: pointer;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Reference Line Style:</label>
                                <select id="reference-line-style" style="width: 80px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                                    <option value="solid">Solid</option>
                                    <option value="dashed">Dashed</option>
                                    <option value="dotted">Dotted</option>
                                    <option value="dash-dot">Dash-Dot</option>
                                </select>
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Actual Line Style:</label>
                                <select id="actual-line-style" style="width: 80px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                                    <option value="solid">Solid</option>
                                    <option value="dashed">Dashed</option>
                                    <option value="dotted">Dotted</option>
                                    <option value="dash-dot">Dash-Dot</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Panel -->
                <div class="control-panel">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleStatusPanel()">
                        Status
                        <span id="status-toggle" style="font-size: 0.8rem; opacity: 0.7;">▶</span>
                    </h3>
                    <div id="status-content" class="status-content collapsed">
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">
                            Simulation
                        </span>
                        <span id="simulation-status" class="status-value">Stopped</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Iterations</span>
                        <span id="iteration-count" class="status-value">0</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Power Flow</span>
                        <span id="power-flow-status" class="status-value">Converged</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Voltage (Bus 2)</span>
                        <span id="bus-voltage" class="status-value">1.000 pu</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Reactive Power</span>
                        <span id="reactive-power" class="status-value">0.000 pu</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Version</span>
                        <span id="build-version" class="status-value">__BUILD_VERSION__</span>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="voltage-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="reactive-chart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display"></div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboard-shortcuts-modal" class="keyboard-shortcuts-modal">
        <div class="keyboard-shortcuts-header">
            <h2>Keyboard Shortcuts</h2>
            <button id="keyboard-shortcuts-close" class="keyboard-shortcuts-close" title="Close">×</button>
        </div>
            
            <div class="shortcuts-section">
                <h3>Simulation Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Space</span>
                    </div>
                    <div class="shortcut-description">Start/Stop simulation</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Shift</span>
                        <span class="shortcut-key">Space</span>
                    </div>
                    <div class="shortcut-description">Reset simulation</div>
                </div>
            </div>

            <div class="shortcuts-section">
                <h3>Voltage Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">↑</span>
                    </div>
                    <div class="shortcut-description">Increase voltage (coarse adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">↓</span>
                    </div>
                    <div class="shortcut-description">Decrease voltage (coarse adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">→</span>
                    </div>
                    <div class="shortcut-description">Increase voltage (fine adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">←</span>
                    </div>
                    <div class="shortcut-description">Decrease voltage (fine adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Ctrl</span>
                        <span class="shortcut-key">↑</span>
                    </div>
                    <div class="shortcut-description">Set voltage to maximum (110%)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Ctrl</span>
                        <span class="shortcut-key">↓</span>
                    </div>
                    <div class="shortcut-description">Set voltage to minimum (90%)</div>
                </div>
            </div>

            <div class="shortcuts-section">
                <h3>Chart Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">M</span>
                    </div>
                    <div class="shortcut-description">Maximize/minimize chart (defaults to voltage chart)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Double-click</span>
                    </div>
                    <div class="shortcut-description">Maximize/minimize specific chart</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Mouse wheel</span>
                    </div>
                    <div class="shortcut-description">Zoom chart time window (5-50 seconds)</div>
                </div>
            </div>

            <div class="shortcuts-section">
                <h3>Interface Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">?</span>
                    </div>
                    <div class="shortcut-description">Show keyboard shortcuts help</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-description">Toggle sidebar (show/hide control panels)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">1</span>
                    </div>
                    <div class="shortcut-description">Set charts to single column layout</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">2</span>
                    </div>
                    <div class="shortcut-description">Set charts to two column layout</div>
                </div>
            </div>
    </div>

    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Embedded Python Code -->
    <script type="text/python" id="embedded-newton-raphson">
import numpy as np
import math as m

def GenericNewtonRaphson(Ybus_matrix, Vreg_mag, Sgen, 
                        Sload=None, Sload_const_I=None, Sload_const_Y=None,
                        Qgen_min=None, Qgen_max=None, Qgen_cap=None, 
                        initial_V=None, Final_Output=False, Verbose_Output=False):
    """Generic Newton-Raphson Power Flow solver"""
    
    # Slack bus (known voltage, fixed angle of 0) must be bus 1
    num_buses = len(Ybus_matrix)
    
    # Input validation
    if len(Ybus_matrix[0]) != num_buses:
        raise ValueError("Ybus_matrix must be square")
        
    if len(Vreg_mag) != num_buses:
        raise ValueError("Vreg_mag size mismatch")
    
    if Sload is None:
        Sload = [complex() for x in range(num_buses)]
    
    if len(Sgen) != num_buses or len(Sload) != num_buses:
        raise ValueError("Sgen/Sload size mismatch")
    
    # Additional validation for optional parameters
    for param in [Sload_const_I, Sload_const_Y, Qgen_max, Qgen_min, Qgen_cap]:
        if param is not None and len(param) != num_buses:
            raise ValueError("Optional parameter size mismatch")
    
    # Solver parameters
    TOLERANCE = 1.0e-9
    MAX_ITERATIONS = 200
    
    # Determine which buses have regulated voltage
    Vreg_declared = [Vreg_mag[i] is not None for i in range(num_buses)]
    
    # Convert Ybus to magnitude and angle arrays for faster computation
    Ybus_mag = [[abs(Ybus_matrix[i][j]) for j in range(num_buses)] for i in range(num_buses)]
    Ybus_ang = [[np.angle(Ybus_matrix[i][j], deg=False) for j in range(num_buses)] for i in range(num_buses)]
    
    # Initialize voltage vector
    if initial_V is None:
        V = [complex(real=Vreg_mag[x] if Vreg_declared[x] else Vreg_mag[0], imag=0.0) 
             for x in range(num_buses)]
    else:
        V = [complex(real=initial_V[x].real if not Vreg_declared[x] else Vreg_mag[x],
                    imag=initial_V[x].imag) for x in range(num_buses)]
    
    Vmag = [abs(x) for x in V]
    Vang = [np.angle(x, deg=False) for x in V]
    S = [complex() for x in range(num_buses)]
    
    size = (num_buses - 1) * 2
    mismatch = [0.0 for x in range(size)]
    iteration = 0
    solved = False
    
    def calculate_Jacobian():
        """Calculate Jacobian matrix for Newton-Raphson iteration"""
        jacobian = [[0.0 for x in range(size)] for y in range(size)]
        
        for i in range(1, num_buses):
            for j in range(1, num_buses):
                # del P / del delta (angle)
                if i == j:
                    temp = 0.0
                    for k in range(num_buses):
                        if k != i:
                            temp += (Ybus_mag[i][k] * Vmag[k] * 
                                   m.sin(Vang[i] - Vang[k] - Ybus_ang[i][k]))
                    temp *= -Vmag[i]
                    jacobian[i - 1][j - 1] = temp
                else:
                    jacobian[i - 1][j - 1] = (Vmag[i] * Ybus_mag[i][j] * Vmag[j] * 
                                             m.sin(Vang[i] - Vang[j] - Ybus_ang[i][j]))
                
                # del P / del V (voltage magnitude)
                if i == j:
                    temp = Vmag[i] * Ybus_mag[i][j] * m.cos(Ybus_ang[i][j])
                    for k in range(num_buses):
                        temp += (Ybus_mag[i][k] * Vmag[k] * 
                               m.cos(Vang[i] - Vang[k] - Ybus_ang[i][k]))
                    jacobian[i - 1][j + num_buses - 2] = temp
                else:
                    jacobian[i - 1][j + num_buses - 2] = (Vmag[i] * Ybus_mag[i][j] * 
                                                         m.cos(Vang[i] - Vang[j] - Ybus_ang[i][j]))
                
                # del Q / del delta (angle)
                if i == j:
                    temp = 0.0
                    for k in range(num_buses):
                        if k != i:
                            temp += (Ybus_mag[i][k] * Vmag[k] * 
                                   m.cos(Vang[i] - Vang[k] - Ybus_ang[i][k]))
                    temp *= Vmag[i]
                    jacobian[i + num_buses - 2][j - 1] = temp
                else:
                    jacobian[i + num_buses - 2][j - 1] = (-Vmag[i] * Ybus_mag[i][j] * Vmag[j] * 
                                                         m.cos(Vang[i] - Vang[j] - Ybus_ang[i][j]))
                
                # del Q / del V (voltage magnitude)
                if i == j:
                    temp = -Vmag[i] * Ybus_mag[i][j] * m.sin(Ybus_ang[i][j])
                    for k in range(num_buses):
                        temp += (Ybus_mag[i][k] * Vmag[k] * 
                               m.sin(Vang[i] - Vang[k] - Ybus_ang[i][k]))
                    jacobian[i + num_buses - 2][j + num_buses - 2] = temp
                else:
                    jacobian[i + num_buses - 2][j + num_buses - 2] = (Vmag[i] * Ybus_mag[i][j] * 
                                                                     m.sin(Vang[i] - Vang[j] - Ybus_ang[i][j]))
        
        return jacobian
    
    # Main Newton-Raphson iteration loop
    while True:
        jacobian = calculate_Jacobian()
        
        # Update voltage phasors
        for i in range(1, num_buses):
            V[i] = complex(real=Vmag[i] * m.cos(Vang[i]),
                          imag=Vmag[i] * m.sin(Vang[i]))
        
        # Calculate currents and power
        I = np.matmul(Ybus_matrix, V)
        S = [V[i] * np.conjugate(I[i]) for i in range(num_buses)]
        
        # Determine voltage regulation status
        Vregulating = [False for x in range(num_buses)]
        
        for i in range(1, num_buses):
            if Vreg_declared[i]:
                under = False
                over = False
                
                # Check reactive power limits
                if Qgen_min is not None and Qgen_min[i] is not None:
                    if (S[i].imag + Sload[i].imag) <= Qgen_min[i] or Vmag[i] > Vreg_mag[i]:
                        under = True
                        Sgen[i] = complex(real=Sgen[i].real, imag=Qgen_min[i])
                
                if Qgen_max is not None and Qgen_max[i] is not None:
                    if (S[i].imag + Sload[i].imag) >= Qgen_max[i] or Vmag[i] < Vreg_mag[i]:
                        over = True
                        Sgen[i] = complex(real=Sgen[i].real, imag=Qgen_max[i])
                
                Vregulating[i] = (not under) and (not over)
            
            # Calculate net power injection
            Snet = Sgen[i] - Sload[i]
            
            # Apply constant current loads
            if Sload_const_I is not None and Sload_const_I[i] is not None:
                Snet -= (Vmag[i] * Sload_const_I[i])
            
            # Apply constant admittance loads
            if Sload_const_Y is not None and Sload_const_Y[i] is not None:
                Snet -= (m.pow(Vmag[i], 2) * Sload_const_Y[i])
            
            # Calculate power mismatch
            Serr = Snet - S[i]
            
            # Set up mismatch vector
            mismatch[i - 1] = Serr.real
            
            if Vregulating[i]:
                mismatch[i + num_buses - 2] = 0.0
            else:
                mismatch[i + num_buses - 2] = Serr.imag
        
        # Solve for corrections
        try:
            del_val = np.matmul(np.linalg.inv(jacobian), mismatch)
        except np.linalg.LinAlgError:
            break
        
        # Apply corrections
        for i in range(1, num_buses):
            Vang[i] += del_val[i - 1]
            
            if Vreg_declared[i]:
                if Vregulating[i]:
                    Vmag[i] = Vreg_mag[i]
                else:
                    Vmag[i] += del_val[i + num_buses - 2]
            else:
                Vmag[i] += del_val[i + num_buses - 2]
        
        iteration += 1
        
        # Check for convergence or maximum iterations
        if len(del_val) > 0:
            max_mismatch = max(np.max(del_val), -np.min(del_val))
        else:
            max_mismatch = float('inf')
        
        if iteration >= MAX_ITERATIONS:
            break
        elif max_mismatch <= TOLERANCE:
            solved = True
            break
    
    # Final voltage calculation
    for i in range(1, num_buses):
        V[i] = complex(real=Vmag[i] * m.cos(Vang[i]),
                      imag=Vmag[i] * m.sin(Vang[i]))
    
    # Final power calculation
    I = np.matmul(Ybus_matrix, V)
    S = [V[i] * np.conjugate(I[i]) for i in range(num_buses)]
    
    return [V, S, solved]
    </script>

    <script type="text/python" id="embedded-voltage-control">
# Phase 2: Complex 5-bus power system with IBR controls
import numpy as np
import random

# Dynamic Simulation / Plotting Parameters  
DELT = 0.020
NUM_STEPS_PER_UPDATE = 1
WINDOW_TIME = 30.0
NOISE = 0.0005  # pu

# Power System Parameters
SYS_XE = 0.5  # pu, on 100 MVA base (adjustable)

MPT_X = 0.10  # pu, on 100 MVA base
MPT_R = MPT_X / 45.0  # assumed X/R ratio of 45
MPT_TAP = 1.025  # adjustable, initial value
MPT_Z = complex(MPT_R, MPT_X)

COL_BUS_jB = complex(0.0, 0.0)  # initial value, reactive resources
COL_R = 0.04
COL_X = 0.06
COL_G = 0.0  # n/a
COL_B = 0.06
COL_Z = complex(COL_R, COL_X)
COL_Y = complex(COL_G, COL_B/2.0)

GSU_X = 0.06  # pu, on 100 MVA base
GSU_R = GSU_X / 15.0  # assumed X/R ratio of 15
GSU_TAP = 1.025  # fixed
GSU_Z = complex(GSU_R, GSU_X)

# Inverter Model Parameters
TPQ_PLANT = 0.25  # seconds, delay from PPC command to actual output
TV_PLANT = 0.20   # seconds, applied to voltage feedback

INV_VFREEZE = False  # boolean for voltage ride-through control
INV_KFACT = 8.0
INV_VRT_BAND = 0.10  # pu (adjustable)
INV_VRT_HYST = 0.005  # pu, hysteresis

# PPC Tuning Parameters
TVPQ_PPC = 0.5  # seconds, delay in obtaining feedback values
VCTRL_MODE = 1  # MODE=0 is REPC style, MODE=1 is Q(V) control with inner loop Q regulator

VCTRL_DB = 0.005  # deadband, in pu
VCTRL_KP = 0.5  # proportional gain
VCTRL_KI = 0.2  # integral gain
VCTRL_TLAG = 5.0  # intentional lag time constant
VCTRL_DROOP = 0.05  # droop, in pu of 100 MVA base
VCTRL_QCMD_MIN = -0.4  # minimum command, in pu of 100 MVA base
VCTRL_QCMD_MAX = 0.4  # maximum command, in pu of 100 MVA base
VCTRL_QREF_MIN = -0.329  # minimum reference setpoint (Q(V) control only)
VCTRL_QREF_MAX = 0.329  # maximum reference setpoint (Q(V) control only)
VCTRL_FEEDFORWARD = True  # feedforward path (Q(V) control only)

PCTRL_KP = 0.5  # proportional gain
PCTRL_KI = 0.1  # integral gain
PCTRL_FEEDFORWARD = True  # feedforward path

# Initialization Values
VINIT = 1.025  # pu, magnitude only
PINIT = 0.8  # pu, net output
QINIT = 0.0  # pu, net output

# Calculate initial system conditions
IINIT = np.conjugate(complex(PINIT, QINIT)) / VINIT
VSYS = abs(VINIT - IINIT * complex(0, SYS_XE))

VCOL_INIT = VINIT / MPT_TAP + IINIT * MPT_Z * MPT_TAP
ICOL_INIT = (VCOL_INIT - VINIT / MPT_TAP) / MPT_Z

SCOL_INIT = VCOL_INIT * np.conjugate(ICOL_INIT)
PCOL_INIT = SCOL_INIT.real  # initial collector active power output (to MPT)
QCOL_INIT = SCOL_INIT.imag  # initial collector reactive power output (to MPT)

VGSU_INIT = (VCOL_INIT * (1.0/COL_Z + COL_Y) + ICOL_INIT) * COL_Z
IGSU_INIT = VGSU_INIT * (1.0/COL_Z + COL_Y) - VCOL_INIT / COL_Z

VINV_INIT = VGSU_INIT / GSU_TAP + IGSU_INIT * GSU_Z * GSU_TAP
IINV_INIT = (VINV_INIT - VGSU_INIT / GSU_TAP) / GSU_Z

SINV_INIT = VINV_INIT * np.conjugate(IINV_INIT)
PINV_INIT = SINV_INIT.real  # initial inverter active power output
QINV_INIT = SINV_INIT.imag  # initial inverter reactive power output

# Error Handling
if VCTRL_MODE == 1:
    VCTRL_DROOP = max(abs(VCTRL_DROOP), 0.005)  # 0.5% droop minimum

def get_Ybus_matrix():
    """Generate 5-bus system Ybus matrix"""
    global SYS_XE, MPT_Z, COL_Z, COL_Y, GSU_Z
    
    num_buses = 5
    Ybus_matrix = [[complex() for c in range(num_buses)] for r in range(num_buses)]
    
    Sys_Z = complex(0.0, SYS_XE)
    Yext = 1.0 / Sys_Z
    
    Ybus_matrix[0][0] = Yext
    Ybus_matrix[0][1] = -Yext
    
    Ybus_matrix[1][0] = -Yext
    Ybus_matrix[1][1] = Yext + 1.0 / (MPT_Z * np.power(MPT_TAP, 2))
    Ybus_matrix[1][2] = -1.0 / (MPT_Z * MPT_TAP)
    
    Ybus_matrix[2][1] = -1.0 / (MPT_Z * MPT_TAP)
    Ybus_matrix[2][2] = 1.0 / MPT_Z + 1.0 / COL_Z + COL_Y + COL_BUS_jB
    Ybus_matrix[2][3] = -1.0 / COL_Z
    
    Ybus_matrix[3][2] = -1.0 / COL_Z
    Ybus_matrix[3][3] = 1.0 / COL_Z + COL_Y + 1.0 / (GSU_Z * np.power(GSU_TAP, 2))
    Ybus_matrix[3][4] = -1.0 / (GSU_Z * GSU_TAP)
    
    Ybus_matrix[4][3] = -1.0 / (GSU_Z * GSU_TAP)
    Ybus_matrix[4][4] = 1.0 / GSU_Z
    
    return Ybus_matrix

# Control state variables initialized based on system conditions
if VCTRL_MODE == 0:  # REPC style
    if VCTRL_KI > 0.0:  # integrator is used
        VREF_INIT = VINIT + VCTRL_DROOP * QINIT  # assume in center of deadband
    else:  # integrator is not used
        err = QINV_INIT / max(VCTRL_KP, 0.001)
        if err > 0.0:
            err += abs(VCTRL_DB)
        elif err < 0.0:
            err -= abs(VCTRL_DB)
        VREF_INIT = err + VINIT + VCTRL_DROOP * QINIT
elif VCTRL_MODE == 1:  # Q(V) style
    if VCTRL_KI > 0.0:  # integrator is used
        QREF_INIT = QINIT  # no steady-state error
    else:  # integrator is not used
        if VCTRL_FEEDFORWARD:
            QREF_INIT = (QINV_INIT + VCTRL_KP * QINIT) / (1.0 + VCTRL_KP)
        else:
            err = QINV_INIT / max(VCTRL_KP, 0.001)
            QREF_INIT = QINIT + err
    err = QREF_INIT * VCTRL_DROOP
    if err > 0.0:
        err += abs(VCTRL_DB)
    elif err < 0.0:
        err -= abs(VCTRL_DB)
    VREF_INIT = err + VINIT
else:
    VREF_INIT = VINIT
    QREF_INIT = QINIT

# Ensure QREF_INIT is always defined
if 'QREF_INIT' not in locals():
    QREF_INIT = QINIT

# Initialize data arrays
t_vals = [-2*DELT, -DELT]
vpoi_vals = [VINIT for t in t_vals]
vpoi_ref_vals = [VREF_INIT for t in t_vals]
vpoi_cmp_vals = [VREF_INIT for t in t_vals]

ppoi_vals = [PINIT for t in t_vals]
qpoi_vals = [QINIT for t in t_vals]
ppoi_ref_vals = [PINIT for t in t_vals]

if VCTRL_MODE == 1:
    qpoi_ref_vals = [QREF_INIT for t in t_vals]
else:
    qpoi_ref_vals = [QINIT for t in t_vals]

vcol_vals = [abs(VCOL_INIT) for t in t_vals]
pcol_vals = [PCOL_INIT for t in t_vals]
qcol_vals = [QCOL_INIT for t in t_vals]

vinv_vals = [abs(VINV_INIT) for t in t_vals]
pinv_vals = [PINV_INIT for t in t_vals]
qinv_vals = [QINV_INIT for t in t_vals]

pcmd_vals = [PINV_INIT for t in t_vals]
qcmd_vals = [QINV_INIT for t in t_vals]

# Initialize Ybus matrix
Ybus_matrix = get_Ybus_matrix()
past_solution = None

# Control integrator states
KIQ_CMD_STORE = 0.0
KIP_CMD_STORE = 0.0
TQLAG_CMD_STORE = 0.0

TV_INV_STORE = 0.0
TP_INV_STORE = 0.0
TQ_INV_STORE = 0.0

TV_PPC_STORE = 0.0
TP_PPC_STORE = 0.0
TQ_PPC_STORE = 0.0

vpoi_fdbk = VINIT
ppoi_fdbk = PINIT
qpoi_fdbk = QINIT
qcmd_pre_lag = QINV_INIT
vinv_fdbk = abs(VINV_INIT)

current_time = 0.0
iteration_count = 0

# Compatibility wrapper class
class SimulationState:
    """Compatibility wrapper for 5-bus system"""
    def __init__(self):
        self.DELT = DELT
        self.current_time = current_time
        self.iteration_count = iteration_count
        self.data_time_span = WINDOW_TIME
        self.max_data_points = int(WINDOW_TIME / DELT)
        
    def get_current_data(self):
        global t_vals, vpoi_vals, vpoi_ref_vals, qpoi_vals, qpoi_ref_vals
        return {
            'time_values': t_vals.copy(),
            'voltage_reference': vpoi_ref_vals.copy(),
            'voltage_actual': vpoi_vals.copy(),
            'reactive_reference': qpoi_ref_vals.copy(),
            'reactive_actual': qpoi_vals.copy(),
            'current_time': current_time,
            'iteration_count': iteration_count,
            'converged': True
        }
    
    def reset_simulation(self):
        reset_simulation()
    
    def update_parameters(self, param_dict):
        return update_simulation_parameters(param_dict)

# get_Ybus_matrix function is already defined above

def update_simulation_parameters(param_dict):
    \"\"\"Update 5-bus system parameters\"\"\"
    global SYS_XE, MPT_TAP, VCTRL_MODE, VCTRL_KP, VCTRL_KI, VCTRL_DROOP
    global Ybus_matrix
    
    updated_params = []
    
    if 'system_reactance' in param_dict:
        SYS_XE = max(0.1, min(2.0, param_dict['system_reactance']))
        Ybus_matrix = get_Ybus_matrix()
        updated_params.append('system_reactance')
    
    if 'voltage_kp' in param_dict:
        VCTRL_KP = max(0.0, param_dict['voltage_kp'])
        updated_params.append('voltage_kp')
    
    if 'voltage_ki' in param_dict:
        VCTRL_KI = max(0.0, param_dict['voltage_ki'])
        updated_params.append('voltage_ki')
    
    return updated_params

def get_system_parameters():
    \"\"\"Get current system configuration\"\"\"
    return {
        'SYS_XE': SYS_XE,
        'VCTRL_KP': VCTRL_KP,
        'VCTRL_KI': VCTRL_KI,
        'VCTRL_DROOP': VCTRL_DROOP,
        'simulation_interval': DELT * 1000.0,
        'noise_level': NOISE
    }

def reset_simulation():
    \"\"\"Reset all simulation states\"\"\"
    global current_time, iteration_count
    global KIQ_CMD_STORE, KIP_CMD_STORE, TQLAG_CMD_STORE
    global TV_INV_STORE, TP_INV_STORE, TQ_INV_STORE
    global TV_PPC_STORE, TP_PPC_STORE, TQ_PPC_STORE
    global vpoi_fdbk, ppoi_fdbk, qpoi_fdbk, qcmd_pre_lag, vinv_fdbk
    global past_solution, INV_VFREEZE
    
    # Reset time
    current_time = 0.0
    iteration_count = 0
    
    # Reset integrator states
    KIQ_CMD_STORE = 0.0
    KIP_CMD_STORE = 0.0
    TQLAG_CMD_STORE = 0.0
    TV_INV_STORE = 0.0
    TP_INV_STORE = 0.0
    TQ_INV_STORE = 0.0
    TV_PPC_STORE = 0.0
    TP_PPC_STORE = 0.0
    TQ_PPC_STORE = 0.0
    
    # Reset feedback values
    vpoi_fdbk = VINIT
    ppoi_fdbk = PINIT
    qpoi_fdbk = QINIT
    qcmd_pre_lag = QINV_INIT
    vinv_fdbk = abs(VINV_INIT)
    
    # Reset solution
    past_solution = None
    INV_VFREEZE = False
    
    # Reinitialize data arrays
    global t_vals, vpoi_vals, vpoi_ref_vals, vpoi_cmp_vals
    global ppoi_vals, qpoi_vals, ppoi_ref_vals, qpoi_ref_vals
    global vcol_vals, pcol_vals, qcol_vals
    global vinv_vals, pinv_vals, qinv_vals, pcmd_vals, qcmd_vals
    
    t_vals = [-2*DELT, -DELT]
    vpoi_vals = [VINIT for t in t_vals]
    vpoi_ref_vals = [VREF_INIT for t in t_vals]
    vpoi_cmp_vals = [VREF_INIT for t in t_vals]
    ppoi_vals = [PINIT for t in t_vals]
    qpoi_vals = [QINIT for t in t_vals]
    ppoi_ref_vals = [PINIT for t in t_vals]
    if VCTRL_MODE == 1:
        qpoi_ref_vals = [QREF_INIT for t in t_vals]
    else:
        qpoi_ref_vals = [QINIT for t in t_vals]
    vcol_vals = [abs(VCOL_INIT) for t in t_vals]
    pcol_vals = [PCOL_INIT for t in t_vals]
    qcol_vals = [QCOL_INIT for t in t_vals]
    vinv_vals = [abs(VINV_INIT) for t in t_vals]
    pinv_vals = [PINV_INIT for t in t_vals]
    qinv_vals = [QINV_INIT for t in t_vals]
    pcmd_vals = [PINV_INIT for t in t_vals]
    qcmd_vals = [QINV_INIT for t in t_vals]

# Create simulation state for compatibility
sim_state = SimulationState()
print("Phase 2: 5-bus simulation state initialized successfully.")

def simulate_step(voltage_reference):
    """Main simulation step for 5-bus system with advanced IBR controls"""
    global current_time, iteration_count, past_solution
    global KIQ_CMD_STORE, KIP_CMD_STORE, TQLAG_CMD_STORE
    global TV_INV_STORE, TP_INV_STORE, TQ_INV_STORE
    global TV_PPC_STORE, TP_PPC_STORE, TQ_PPC_STORE
    global vpoi_fdbk, ppoi_fdbk, qpoi_fdbk, qcmd_pre_lag, vinv_fdbk
    global INV_VFREEZE
    global Ybus_matrix
    
    try:
        current_time += DELT
        iteration_count += 1
        
        # Update time and reference values
        t_vals.append(current_time)
        vpoi_ref_vals.append(float(voltage_reference))
        ppoi_ref_vals.append(PINIT)  # Fixed active power for now
        
        # PPC feedback values (delayed by 1 timestep)
        vpoi_prev = vpoi_vals[-1]
        ppoi_prev = ppoi_vals[-1]
        qpoi_prev = qpoi_vals[-1]
        vinv_prev = vinv_vals[-1]
        
        # PPC lag filters
        DSTATE = (vpoi_prev - vpoi_fdbk) / TVPQ_PPC
        TV_PPC_STORE += DSTATE * DELT
        vpoi_fdbk = TV_PPC_STORE + DSTATE * DELT / 2.0
        
        DSTATE = (ppoi_prev - ppoi_fdbk) / TVPQ_PPC
        TP_PPC_STORE += DSTATE * DELT
        ppoi_fdbk = TP_PPC_STORE + DSTATE * DELT / 2.0
        
        DSTATE = (qpoi_prev - qpoi_fdbk) / TVPQ_PPC
        TQ_PPC_STORE += DSTATE * DELT
        qpoi_fdbk = TQ_PPC_STORE + DSTATE * DELT / 2.0
        
        # Inverter voltage feedback lag
        DSTATE = (vinv_prev - vinv_fdbk) / TV_PLANT
        TV_INV_STORE += DSTATE * DELT
        vinv_fdbk = TV_INV_STORE + DSTATE * DELT / 2.0
        
        # Voltage Control Logic
        if VCTRL_MODE == 0:  # Standard REPC style controller
            v_feedback_with_droop = vpoi_fdbk + qpoi_fdbk * VCTRL_DROOP
            vpoi_cmp_vals.append(v_feedback_with_droop)
            error = vpoi_ref_vals[-1] - v_feedback_with_droop
            
            # Deadband logic
            if error > abs(VCTRL_DB):
                error -= abs(VCTRL_DB)
            elif error < -abs(VCTRL_DB):
                error += abs(VCTRL_DB)
            else:
                error = 0.0
            
            # Voltage controller with anti-windup and VRT freeze
            DSTATE = error * (VCTRL_KI if VCTRL_KI > 0.0 else 0.0)
            if INV_VFREEZE:
                if vinv_fdbk > 1.0 and error > 0.0:
                    DSTATE = 0.0
                if vinv_fdbk < 1.0 and error < 0.0:
                    DSTATE = 0.0
            
            KIQ_CMD_STORE += DSTATE * DELT
            qcmd_pre_lag = error * VCTRL_KP + KIQ_CMD_STORE + DELT * DSTATE / 2.0
            
            # Command lag filter
            if VCTRL_TLAG >= 2.0 * DELT:
                DSTATE = (qcmd_pre_lag - qcmd_vals[-1]) / VCTRL_TLAG
                TQLAG_CMD_STORE += DSTATE * DELT
                
                TQLAG_CMD_STORE = max(VCTRL_QCMD_MIN, min(VCTRL_QCMD_MAX, TQLAG_CMD_STORE))
                Qcmd = TQLAG_CMD_STORE + DSTATE * DELT / 2.0
            else:
                Qcmd = qcmd_pre_lag  # bypass lag
            
            Qcmd = max(VCTRL_QCMD_MIN, min(VCTRL_QCMD_MAX, Qcmd))
            qpoi_ref_vals.append(QINIT)  # not used in MODE = 0
            
        elif VCTRL_MODE == 1:  # Q(V) droop style controller with inner-loop regulator
            v_feedback_with_droop = vpoi_fdbk  # no droop applied here
            vpoi_cmp_vals.append(v_feedback_with_droop)
            error = vpoi_ref_vals[-1] - v_feedback_with_droop
            
            # Deadband logic
            if error > abs(VCTRL_DB):
                error -= abs(VCTRL_DB)
            elif error < -abs(VCTRL_DB):
                error += abs(VCTRL_DB)
            else:
                error = 0.0
            
            # Q(V) droop calculation
            qcmd_pre_lag = error / VCTRL_DROOP
            if VCTRL_TLAG >= 2.0 * DELT:
                DSTATE = (qcmd_pre_lag - qpoi_ref_vals[-1]) / VCTRL_TLAG
                TQLAG_CMD_STORE += DSTATE * DELT
                
                TQLAG_CMD_STORE = max(VCTRL_QREF_MIN, min(VCTRL_QREF_MAX, TQLAG_CMD_STORE))
                Qref = TQLAG_CMD_STORE + DSTATE * DELT / 2.0
            else:
                Qref = qcmd_pre_lag  # bypass lag
            
            Qref = max(VCTRL_QREF_MIN, min(VCTRL_QREF_MAX, Qref))
            qpoi_ref_vals.append(Qref)
            
            # Inner loop Q regulator
            error = Qref - qpoi_fdbk
            DSTATE = error * (VCTRL_KI if VCTRL_KI > 0.0 else 0.0)
            
            if INV_VFREEZE:
                if vinv_fdbk > 1.0 and error > 0.0:
                    DSTATE = 0.0
                if vinv_fdbk < 1.0 and error < 0.0:
                    DSTATE = 0.0
            
            KIQ_CMD_STORE += DSTATE * DELT
            Qcmd = (Qref if VCTRL_FEEDFORWARD else 0.0) + error * VCTRL_KP + KIQ_CMD_STORE + DELT * DSTATE / 2.0
            Qcmd = max(VCTRL_QCMD_MIN, min(VCTRL_QCMD_MAX, Qcmd))
        else:
            # Default case
            qpoi_ref_vals.append(QINIT)
            Qcmd = QINV_INIT
        
        qcmd_vals.append(Qcmd)
        
        # Inverter reactive power plant dynamics with VRT logic
        q_last = qinv_vals[-1]
        q_err = Qcmd - q_last
        if INV_VFREEZE:
            if vinv_fdbk > 1.0 and q_err > 0.0:
                q_err = min((1.0 + INV_VRT_BAND) - vinv_fdbk, 0.0) * INV_KFACT
            if vinv_fdbk < 1.0 and q_err < 0.0:
                q_err = max((1.0 - INV_VRT_BAND) - vinv_fdbk, 0.0) * INV_KFACT
        
        DSTATE = q_err / TPQ_PLANT
        TQ_INV_STORE += DSTATE * DELT
        qinv_new = TQ_INV_STORE + DELT * DSTATE / 2.0 + (random.random()-0.5)*2.0*NOISE
        qinv_vals.append(qinv_new)
        
        # Active power control (simplified for now)
        error = ppoi_ref_vals[-1] - ppoi_fdbk
        DSTATE = error * PCTRL_KI
        KIP_CMD_STORE += DSTATE * DELT
        Pcmd = (ppoi_ref_vals[-1] if PCTRL_FEEDFORWARD else 0.0) + error * PCTRL_KP + KIP_CMD_STORE + DELT * DSTATE / 2.0
        pcmd_vals.append(Pcmd)
        
        # Inverter active power plant dynamics
        p_last = pinv_vals[-1]
        p_err = Pcmd - p_last
        DSTATE = p_err / TPQ_PLANT
        TP_INV_STORE += DSTATE * DELT
        pinv_new = TP_INV_STORE + DELT * DSTATE / 2.0 + (random.random()-0.5)*2.0*NOISE
        pinv_vals.append(pinv_new)
        
        # Add system noise to system voltage
        Vsys_noisy = VSYS + (random.random()-0.5)*2.0*NOISE
        
        # Solve 5-bus power flow
        Vout, Sout, solved = GenericNewtonRaphson(
            Ybus_matrix=Ybus_matrix,
            Vreg_mag=[complex(Vsys_noisy), None, None, None, None],
            Sgen=[None, complex(), complex(), complex(), complex(pinv_new, qinv_new)],
            initial_V=past_solution,
            Verbose_Output=False
        )
        
        if solved:
            past_solution = Vout
            # Update voltage measurements
            vpoi_vals.append(abs(Vout[1]))  # POI voltage
            vcol_vals.append(abs(Vout[2]))  # Collector voltage
            vinv_vals.append(abs(Vout[4]))  # Inverter terminal voltage
            
            # Calculate power flows
            Spoi = Vout[1] * np.conjugate((Vout[1] - Vout[0]) / complex(0, SYS_XE))
            ppoi_vals.append(Spoi.real)
            qpoi_vals.append(Spoi.imag)
            
            Scol = Vout[2] * np.conjugate((Vout[2] - Vout[1]/MPT_TAP) / MPT_Z)
            pcol_vals.append(Scol.real)
            qcol_vals.append(Scol.imag)
        else:
            # Power flow failed - use previous values
            vpoi_vals.append(vpoi_vals[-1])
            vcol_vals.append(vcol_vals[-1])
            vinv_vals.append(vinv_vals[-1])
            ppoi_vals.append(ppoi_vals[-1])
            qpoi_vals.append(qpoi_vals[-1])
            pcol_vals.append(pcol_vals[-1])
            qcol_vals.append(qcol_vals[-1])
        
        # VRT state logic
        if vinv_fdbk > (1.0 + INV_VRT_BAND) or vinv_fdbk < (1.0 - INV_VRT_BAND):
            INV_VFREEZE = True
        elif vinv_fdbk > (1.0 - (INV_VRT_BAND - INV_VRT_HYST)) and vinv_fdbk < (1.0 + (INV_VRT_BAND - INV_VRT_HYST)):
            INV_VFREEZE = False
        
        # Maintain rolling window
        while t_vals[0] < current_time - WINDOW_TIME:
            t_vals.pop(0)
            vpoi_vals.pop(0)
            vpoi_ref_vals.pop(0)
            vpoi_cmp_vals.pop(0)
            ppoi_vals.pop(0)
            qpoi_vals.pop(0)
            ppoi_ref_vals.pop(0)
            qpoi_ref_vals.pop(0)
            vcol_vals.pop(0)
            pcol_vals.pop(0)
            qcol_vals.pop(0)
            vinv_vals.pop(0)
            pinv_vals.pop(0)
            qinv_vals.pop(0)
            pcmd_vals.pop(0)
            qcmd_vals.pop(0)
        
        # Update simulation state
        sim_state.current_time = current_time
        sim_state.iteration_count = iteration_count
        
        return {
            'time': current_time,
            'voltage_reference': voltage_reference,
            'voltage_actual': vpoi_vals[-1],
            'reactive_reference': qpoi_ref_vals[-1],
            'reactive_actual': qpoi_vals[-1],
            'converged': solved,
            'iteration': iteration_count,
            'data_arrays': sim_state.get_current_data()
        }
        
    except Exception as e:
        print(f"5-bus simulation error at time {current_time}: {e}")
        return {
            'time': current_time,
            'voltage_reference': voltage_reference,
            'voltage_actual': 1.0,
            'reactive_reference': 0.0,
            'reactive_actual': 0.0,
            'converged': False,
            'error': str(e),
            'iteration': iteration_count,
            'data_arrays': sim_state.get_current_data()
        }

def update_simulation_parameters(param_dict):
    return sim_state.update_parameters(param_dict)

def get_simulation_data():
    return sim_state.get_current_data()

def reset_simulation():
    sim_state.reset_simulation()
    return True

def get_simulation_config():
    """Get current simulation configuration"""
    return get_system_parameters()

def validate_simulation_health():
    """Check simulation health and provide diagnostics"""
    health_status = {
        'status': 'healthy',
        'warnings': [],
        'data_points': len(t_vals),
        'current_time': current_time,
        'iteration_count': iteration_count
    }
    
    return health_status
    </script>

    <!-- Status Panel Toggle Function -->
    <script>
        function toggleStatusPanel() {
            const content = document.getElementById('status-content');
            const toggle = document.getElementById('status-toggle');
            const controlPanel = content.closest('.control-panel');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlPanel.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlPanel.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleChartConfigPanel() {
            const content = document.getElementById('chart-config-content');
            const toggle = document.getElementById('chart-config-toggle');
            const controlPanel = content.closest('.control-panel');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlPanel.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlPanel.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleVoltageControlPanel() {
            const content = document.getElementById('voltage-control-content');
            const toggle = document.getElementById('voltage-control-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleSystemParametersPanel() {
            const content = document.getElementById('system-parameters-content');
            const toggle = document.getElementById('system-parameters-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleSimulationControlPanel() {
            const content = document.getElementById('simulation-control-content');
            const toggle = document.getElementById('simulation-control-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleTuningPanel() {
            const content = document.getElementById('tuning-content');
            const toggle = document.getElementById('tuning-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }
    </script>
    
    <!-- Main JavaScript Application -->
    <script src="app.js"></script>
</body>
</html>
