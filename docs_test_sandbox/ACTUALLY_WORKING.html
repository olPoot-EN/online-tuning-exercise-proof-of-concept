<!DOCTYPE html>
<html>
<head>
    <title>ACTUALLY WORKING - Fixed Version</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ACTUALLY WORKING - Fixed Sequential Loading</h1>
    <div id="status"></div>
    <div id="output"></div>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        let pyodide = null;
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            document.getElementById('status').appendChild(div);
            console.log(`[${type}] ${message}`);
        }
        
        async function loadAndTest() {
            try {
                // Step 1: Initialize Pyodide
                addStatus('Step 1: Initializing Pyodide...', 'info');
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                addStatus('✓ Pyodide initialized', 'success');
                
                // Step 2: Load NumPy
                addStatus('Step 2: Loading NumPy...', 'info');
                await pyodide.loadPackage(['numpy']);
                addStatus('✓ NumPy loaded', 'success');
                
                // Step 3: Import ALL required modules first
                addStatus('Step 3: Importing all Python modules...', 'info');
                try {
                    pyodide.runPython(`
import numpy as np
import math as m
import math
import random
import sys
print(f"Python version: {sys.version}")
print("All core modules imported successfully")
                    `);
                    addStatus('✓ All core modules imported', 'success');
                } catch (e) {
                    addStatus(`Failed to import modules: ${e.message}`, 'error');
                    throw e;
                }
                
                // Step 4: Load Newton-Raphson
                addStatus('Step 4: Loading Newton-Raphson solver...', 'info');
                try {
                    const newtonResponse = await fetch('newton_raphson_clean.py');
                    if (!newtonResponse.ok) {
                        throw new Error(`HTTP ${newtonResponse.status}: Failed to fetch newton_raphson_clean.py`);
                    }
                    const newtonCode = await newtonResponse.text();
                    addStatus(`  Fetched ${newtonCode.length} bytes`, 'info');
                    
                    // Check if the code starts with import statements that might fail
                    if (newtonCode.includes('import math as m')) {
                        addStatus('  File contains math import', 'info');
                    }
                    
                    // Try to execute the code with error catching
                    try {
                        pyodide.runPython(newtonCode);
                        addStatus('  Code executed without errors', 'success');
                    } catch (pyError) {
                        addStatus(`  Python execution error: ${pyError.message}`, 'error');
                        // Try to get more details
                        const errorDetails = pyodide.runPython(`
import traceback
import sys
exc_info = sys.exc_info()
if exc_info[0]:
    traceback.format_exc()
else:
    "No traceback available"
                        `);
                        addStatus(`  Traceback: ${errorDetails}`, 'error');
                        throw pyError;
                    }
                    
                    // Verify function exists
                    const nrCheck = pyodide.runPython(`
'GenericNewtonRaphson' in globals()
                    `);
                    if (!nrCheck) {
                        throw new Error('GenericNewtonRaphson not found after loading');
                    }
                    addStatus('✓ Newton-Raphson solver loaded successfully', 'success');
                    
                } catch (error) {
                    addStatus(`Failed to load Newton-Raphson: ${error.message}`, 'error');
                    throw error;
                }
                
                // Step 5: Load Voltage Control
                addStatus('Step 5: Loading voltage control system...', 'info');
                try {
                    const voltageResponse = await fetch('voltage_control_clean.py');
                    if (!voltageResponse.ok) {
                        throw new Error(`HTTP ${voltageResponse.status}: Failed to fetch voltage_control_clean.py`);
                    }
                    const voltageCode = await voltageResponse.text();
                    addStatus(`  Fetched ${voltageCode.length} bytes`, 'info');
                    
                    // Execute voltage control code
                    try {
                        pyodide.runPython(voltageCode);
                        addStatus('  Code executed without errors', 'success');
                    } catch (pyError) {
                        addStatus(`  Python execution error: ${pyError.message}`, 'error');
                        throw pyError;
                    }
                    
                    // Verify functions exist
                    const simCheck = pyodide.runPython(`
all([
    'SimulationState' in globals(),
    'simulate_step' in globals(),
    'sim_state' in globals()
])
                    `);
                    if (!simCheck) {
                        throw new Error('Voltage control functions not found after loading');
                    }
                    addStatus('✓ Voltage control system loaded successfully', 'success');
                    
                } catch (error) {
                    addStatus(`Failed to load voltage control: ${error.message}`, 'error');
                    throw error;
                }
                
                // Step 6: Test simulation
                addStatus('Step 6: Testing simulation...', 'info');
                try {
                    const result = pyodide.runPython(`
result = simulate_step(1.05)
print(f"Simulation result: time={result['time']}, voltage={result['voltage_actual']:.4f}")
result
                    `);
                    
                    const jsResult = result.toJs();
                    addStatus('✓ Simulation test successful!', 'success');
                    
                    document.getElementById('output').innerHTML = 
                        '<h2>Result:</h2><pre>' + JSON.stringify(jsResult, null, 2) + '</pre>';
                    
                    addStatus('🎉 SUCCESS - Everything works!', 'success');
                    
                } catch (error) {
                    addStatus(`Simulation test failed: ${error.message}`, 'error');
                    throw error;
                }
                
            } catch (error) {
                addStatus(`❌ FAILED: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            addStatus('Starting test...', 'info');
            loadAndTest();
        });
    </script>
</body>
</html>