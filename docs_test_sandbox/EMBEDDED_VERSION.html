<!DOCTYPE html>
<html>
<head>
    <title>EMBEDDED VERSION - Python in HTML</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>EMBEDDED VERSION - All Python Code in HTML</h1>
    <div id="output"></div>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = msg;
            output.appendChild(p);
            console.log(`[${type}] ${msg}`);
        }
        
        // Embedded Newton-Raphson code (just the first part to test)
        const newtonRaphsonCode = `
import numpy as np
import math as m

def GenericNewtonRaphson(Ybus_matrix, Vreg_mag, Sgen, 
                        Sload=None, Sload_const_I=None, Sload_const_Y=None,
                        Qgen_min=None, Qgen_max=None, Qgen_cap=None, 
                        initial_V=None, Final_Output=False, Verbose_Output=False):
    """Generic Newton-Raphson Power Flow solver - simplified test version"""
    
    # Just return test values for now
    num_buses = 2
    V = [complex(1.0, 0.0), complex(1.0, 0.0)]
    S = [complex(0.0, 0.0), complex(0.8, 0.0)]
    solved = True
    
    return [V, S, solved]

print("Newton-Raphson function loaded successfully")
        `;
        
        // Embedded simplified voltage control code
        const voltageControlCode = `
import numpy as np
import random

class SimulationState:
    def __init__(self):
        self.DELT = 0.01
        self.current_time = 0.0
        self.iteration_count = 0
        print("SimulationState initialized")

# Create global instance
sim_state = SimulationState()

def simulate_step(voltage_reference):
    """Simplified simulation step"""
    global sim_state
    
    sim_state.current_time += sim_state.DELT
    sim_state.iteration_count += 1
    
    # Simple voltage response simulation
    voltage_actual = voltage_reference + random.uniform(-0.01, 0.01)
    
    result = {
        'time': sim_state.current_time,
        'voltage_reference': voltage_reference,
        'voltage_actual': voltage_actual,
        'reactive_reference': 0.0,
        'reactive_actual': 0.0,
        'converged': True,
        'iteration': sim_state.iteration_count
    }
    
    return result

print("Voltage control system loaded successfully")
        `;
        
        async function testEmbedded() {
            try {
                log('Loading Pyodide...', 'info');
                const pyodide = await loadPyodide();
                log('‚úì Pyodide loaded', 'success');
                
                log('Loading NumPy...', 'info');
                await pyodide.loadPackage(['numpy']);
                log('‚úì NumPy loaded', 'success');
                
                log('Loading Newton-Raphson (embedded)...', 'info');
                pyodide.runPython(newtonRaphsonCode);
                
                // Test if function exists
                const nrExists = pyodide.runPython(`'GenericNewtonRaphson' in globals()`);
                if (nrExists) {
                    log('‚úì Newton-Raphson loaded successfully', 'success');
                } else {
                    throw new Error('Newton-Raphson function not found');
                }
                
                log('Loading voltage control (embedded)...', 'info');
                pyodide.runPython(voltageControlCode);
                
                // Test if functions exist
                const vcExists = pyodide.runPython(`'simulate_step' in globals() and 'sim_state' in globals()`);
                if (vcExists) {
                    log('‚úì Voltage control loaded successfully', 'success');
                } else {
                    throw new Error('Voltage control functions not found');
                }
                
                log('Testing simulation...', 'info');
                const result = pyodide.runPython(`
result = simulate_step(1.05)
print(f"Simulation: t={result['time']:.3f}, V={result['voltage_actual']:.4f}")
result
                `);
                
                const jsResult = result.toJs();
                log('‚úì Simulation successful!', 'success');
                
                // Display result
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(jsResult, null, 2);
                output.appendChild(pre);
                
                log('üéâ EMBEDDED VERSION WORKS!', 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        testEmbedded();
    </script>
</body>
</html>