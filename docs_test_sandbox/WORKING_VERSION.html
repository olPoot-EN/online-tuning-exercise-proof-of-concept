<!DOCTYPE html>
<html>
<head>
    <title>WORKING VERSION - Voltage Control Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>WORKING VERSION - Sequential Python Loading</h1>
    <div id="status"></div>
    <div id="output"></div>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        // Global variable to store Pyodide instance
        let pyodide = null;
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            document.getElementById('status').appendChild(div);
            console.log(`[${type}] ${message}`);
        }
        
        async function loadAndTest() {
            try {
                // Step 1: Initialize Pyodide
                addStatus('Step 1: Initializing Pyodide...', 'info');
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                addStatus('✓ Pyodide initialized', 'success');
                
                // Step 2: Load NumPy
                addStatus('Step 2: Loading NumPy...', 'info');
                await pyodide.loadPackage(['numpy']);
                addStatus('✓ NumPy loaded', 'success');
                
                // Step 3: Import NumPy and random in Python
                addStatus('Step 3: Importing Python modules...', 'info');
                pyodide.runPython(`
import numpy as np
import random
import math as m
print("Core modules imported successfully")
                `);
                addStatus('✓ Core modules imported', 'success');
                
                // Step 4: Load Newton-Raphson (MUST BE FIRST)
                addStatus('Step 4: Loading Newton-Raphson solver...', 'info');
                const newtonResponse = await fetch('newton_raphson_clean.py');
                if (!newtonResponse.ok) {
                    throw new Error(`Failed to fetch Newton-Raphson: ${newtonResponse.status}`);
                }
                const newtonCode = await newtonResponse.text();
                addStatus(`  Fetched ${newtonCode.length} bytes`, 'info');
                
                // Execute Newton-Raphson code
                pyodide.runPython(newtonCode);
                
                // Verify it's available
                const nrCheck = pyodide.runPython(`
'GenericNewtonRaphson' in globals()
                `);
                if (!nrCheck) {
                    throw new Error('GenericNewtonRaphson not found in globals after loading');
                }
                addStatus('✓ Newton-Raphson solver loaded and verified', 'success');
                
                // Step 5: Load Voltage Control (MUST BE SECOND)
                addStatus('Step 5: Loading voltage control system...', 'info');
                const voltageResponse = await fetch('voltage_control_clean.py');
                if (!voltageResponse.ok) {
                    throw new Error(`Failed to fetch voltage control: ${voltageResponse.status}`);
                }
                const voltageCode = await voltageResponse.text();
                addStatus(`  Fetched ${voltageCode.length} bytes`, 'info');
                
                // Execute voltage control code
                pyodide.runPython(voltageCode);
                
                // Verify simulation functions
                const simCheck = pyodide.runPython(`
checks = {
    'SimulationState': 'SimulationState' in globals(),
    'simulate_step': 'simulate_step' in globals(),
    'sim_state': 'sim_state' in globals()
}
all(checks.values())
                `);
                if (!simCheck) {
                    throw new Error('Voltage control functions not found in globals after loading');
                }
                addStatus('✓ Voltage control system loaded and verified', 'success');
                
                // Step 6: Test actual simulation
                addStatus('Step 6: Testing simulation...', 'info');
                const result = pyodide.runPython(`
# Test simulation step
result = simulate_step(1.05)
print(f"Simulation completed: time={result['time']}, voltage={result['voltage_actual']:.4f}")
result
                `);
                
                // Convert result to JavaScript object
                const jsResult = result.toJs();
                addStatus('✓ Simulation test successful!', 'success');
                
                // Display result
                const output = document.getElementById('output');
                output.innerHTML = '<h2>Simulation Result:</h2><pre>' + 
                    JSON.stringify(jsResult, null, 2) + '</pre>';
                
                addStatus('🎉 ALL TESTS PASSED - System is working!', 'success');
                
            } catch (error) {
                addStatus(`❌ Error: ${error.message}`, 'error');
                console.error('Full error:', error);
                
                // Try to get more debugging info
                if (pyodide) {
                    try {
                        pyodide.runPython(`
import sys
print(f"Python version: {sys.version}")
print(f"Modules loaded: {list(sys.modules.keys())}")
print(f"Globals available: {[k for k in globals().keys() if not k.startswith('_')]}")
                        `);
                    } catch (e) {
                        console.error('Could not get debug info:', e);
                    }
                }
            }
        }
        
        // Start when page loads
        window.addEventListener('DOMContentLoaded', () => {
            addStatus('Page loaded, starting test...', 'info');
            loadAndTest();
        });
    </script>
</body>
</html>