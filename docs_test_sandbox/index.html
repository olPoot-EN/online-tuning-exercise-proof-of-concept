<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltage Tuning Exercise</title>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div>
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; text-align: center; font-size: 1.2rem; font-weight: 500;">Loading Voltage Tuning Exercise...</p>
            
            <!-- Progress Steps -->
            <div id="loading-steps" style="margin: 2rem 0; text-align: center;">
                <div class="loading-step" id="step-pyodide">
                    <span class="step-icon">⏳</span> Loading Pyodide Runtime
                </div>
                <div class="loading-step" id="step-numpy">
                    <span class="step-icon">⏳</span> Loading NumPy
                </div>
                <div class="loading-step" id="step-charts">
                    <span class="step-icon">⏳</span> Initializing Charts
                </div>
                <div class="loading-step" id="step-python">
                    <span class="step-icon">⏳</span> Loading Python Modules
                </div>
                <div class="loading-step" id="step-simulation">
                    <span class="step-icon">⏳</span> Setting up Simulation
                </div>
            </div>
            
            <!-- Status and Progress -->
            <p id="loading-status" style="text-align: center; color: var(--text-muted); margin-bottom: 0.5rem;">Initializing...</p>
            <p id="loading-detail" style="text-align: center; color: var(--text-muted); font-size: 0.9rem; min-height: 1.2em;">First load typically takes 5-10 seconds</p>
            
            <!-- Progress Bar -->
            <div style="width: 300px; margin: 1rem auto; background: var(--border-color, #ddd); border-radius: 10px; height: 8px;">
                <div id="loading-progress" style="width: 0%; background: var(--primary-color, #3498db); height: 100%; border-radius: 10px; transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <div class="header-buttons">
                <button id="panel-toggle" class="panel-toggle-btn" title="Toggle control panels">
                    <div class="hamburger-icon">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <button id="keyboard-shortcuts-btn" class="keyboard-shortcuts-btn" title="Show keyboard shortcuts">
                    <div class="keyboard-icon">⌨️</div>
                </button>
            </div>
            <h1 style="margin: 0;">Voltage Tuning Exercise: <span class="header-description">Real-time Voltage Control and Power Flow Simulation</span></h1>
        </div>

        <div class="main-grid">
            <!-- Controls Container -->
            <div class="controls-container">
                <!-- Simulation Control Panel -->
                <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleSimulationControlPanel()">
                        Simulation Control
                        <span id="simulation-control-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="simulation-control-content">
                    <div class="simulation-controls" style="display: flex; justify-content: space-between; gap: 4px;">
                        <button id="start-simulation" title="Start simulation (Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--success-color, #27ae60); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Start</button>
                        <button id="stop-simulation" title="Stop simulation (Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--danger-color, #e74c3c); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Stop</button>
                        <button id="reset-simulation" title="Reset simulation (Shift+Space)" style="flex-grow: 1; padding: 0.4rem; background: var(--warning-color, #f39c12); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.85rem;">Reset</button>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Tuning Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleTuningPanel()">
                        Tuning
                        <span id="tuning-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="tuning-content">
                        <div class="config-item">
                            <label>Proportional Gain:</label>
                            <input type="number" id="voltage-kp" value="10.0" min="1.0" max="50.0" step="1.0">
                        </div>
                        <div class="config-item">
                            <label>Integral Gain:</label>
                            <input type="number" id="voltage-ki" value="50.0" min="1.0" max="200.0" step="1.0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Voltage Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleVoltageControlPanel()">
                        Voltage Control
                        <span id="voltage-control-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="voltage-control-content" class="voltage-control">
                        <div class="voltage-display">
                            <span id="voltage-display">100.0</span> %
                        </div>
                        <div class="voltage-slider-container">
                            <button id="voltage-down-large" class="voltage-button" title="Decrease voltage reference by 2%">▼▼</button>
                            <button id="voltage-down" class="voltage-button" title="Decrease voltage reference">▼</button>
                            <input type="range" id="voltage-slider" class="voltage-slider" 
                                   min="90" max="110" value="100" step="0.1" list="voltage-ticks">
                            <datalist id="voltage-ticks">
                                <option value="90"></option>
                                <option value="100"></option>
                                <option value="110"></option>
                            </datalist>
                            <button id="voltage-up" class="voltage-button" title="Increase voltage reference">▲</button>
                            <button id="voltage-up-large" class="voltage-button" title="Increase voltage reference by 2%">▲▲</button>
                        </div>
                        <div class="voltage-range-labels">
                            <span>90%</span>
                            <span>110%</span>
                        </div>
                        <div class="voltage-adjustments">
                            <div class="config-item">
                                <label>Coarse Adjust (%):</label>
                                <input type="number" id="coarse-adjust" value="3.0" min="0.1" max="10.0" step="0.5">
                            </div>
                            <div class="config-item">
                                <label>Fine Adjust (%):</label>
                                <input type="number" id="fine-adjust" value="0.5" min="0.1" max="5.0" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Parameters Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleSystemParametersPanel()">
                        System Parameters
                        <span id="system-parameters-toggle" style="font-size: 0.8rem; opacity: 0.7;">▼</span>
                    </h3>
                    <div id="system-parameters-content">
                    <div class="config-item">
                        <label>Update Rate (ms):</label>
                        <input type="number" id="update-rate" value="10" min="10" max="1000" step="10">
                    </div>
                    <div class="config-item">
                        <label>Noise Level (%):</label>
                        <input type="number" id="noise-level" value="0.2" min="0" max="5.0" step="0.1">
                    </div>
                    <div class="config-item">
                        <label>System Reactance (pu):</label>
                        <input type="number" id="system-reactance" value="0.05" min="0.01" max="0.2" step="0.01">
                    </div>
                    <div class="config-item">
                        <label>Plant Time Constant (s):</label>
                        <input type="number" id="plant-time-constant" value="0.25" min="0.1" max="2.0" step="0.05">
                    </div>
                    </div>
                </div>
            </div>
            
                <!-- Chart Configurations Panel -->
                <div class="control-panel">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleChartConfigPanel()">
                        Chart Configurations
                        <span id="chart-config-toggle" style="font-size: 0.8rem; opacity: 0.7;">▶</span>
                    </h3>
                    <div id="chart-config-content" class="collapsed">
                        <div class="chart-controls" style="margin-top: 0.3rem;">
                            <button id="reset-chart-scales" style="width: 100%; padding: 0.35rem; background: var(--secondary-color, #3498db); color: white; border: none; border-radius: 0.2rem; cursor: pointer; font-size: 0.8rem; margin-bottom: 0.5rem;">
                                Reset Chart Scales
                            </button>
                            
                            <div class="chart-option" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
                                <input type="checkbox" id="chart-expansion" checked style="margin-right: 0.5rem;">
                                <label for="chart-expansion" style="font-size: 0.8rem; color: var(--text-color); cursor: pointer;">Chart Expansion</label>
                            </div>
                            
                            <div class="chart-option" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
                                <input type="checkbox" id="chart-contraction" checked style="margin-right: 0.5rem;">
                                <label for="chart-contraction" style="font-size: 0.8rem; color: var(--text-color); cursor: pointer;">Chart Contraction</label>
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Tail Buffer (s):</label>
                                <input type="number" id="tail-buffer" value="0.5" min="0" max="10" step="0.1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Total Chart Time (s):</label>
                                <input type="number" id="total-chart-time" value="15" min="5" max="50" step="1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Head Buffer (s):</label>
                                <input type="number" id="head-buffer" value="1" min="0" max="5" step="0.1" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Line Width:</label>
                                <input type="number" id="line-width" value="1.5" min="0.5" max="10" step="0.5" style="width: 60px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Reference Color:</label>
                                <input type="color" id="reference-color" value="#e74c3c" style="width: 60px; padding: 0.1rem; border: 1px solid var(--border-color); border-radius: 0.2rem; cursor: pointer;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Actual Color:</label>
                                <input type="color" id="actual-color" value="#3498db" style="width: 60px; padding: 0.1rem; border: 1px solid var(--border-color); border-radius: 0.2rem; cursor: pointer;">
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Reference Line Style:</label>
                                <select id="reference-line-style" style="width: 80px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                                    <option value="solid">Solid</option>
                                    <option value="dashed">Dashed</option>
                                    <option value="dotted">Dotted</option>
                                    <option value="dash-dot">Dash-Dot</option>
                                </select>
                            </div>
                            
                            <div class="config-item" style="margin-bottom: 0.3rem;">
                                <label style="font-size: 0.8rem;">Actual Line Style:</label>
                                <select id="actual-line-style" style="width: 80px; padding: 0.2rem; border: 1px solid var(--border-color); border-radius: 0.2rem; font-size: 0.8rem;">
                                    <option value="solid">Solid</option>
                                    <option value="dashed">Dashed</option>
                                    <option value="dotted">Dotted</option>
                                    <option value="dash-dot">Dash-Dot</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Panel -->
                <div class="control-panel">
                    <h3 style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem;" onclick="toggleStatusPanel()">
                        Status
                        <span id="status-toggle" style="font-size: 0.8rem; opacity: 0.7;">▶</span>
                    </h3>
                    <div id="status-content" class="status-content collapsed">
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">
                            Simulation
                        </span>
                        <span id="simulation-status" class="status-value">Stopped</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Iterations</span>
                        <span id="iteration-count" class="status-value">0</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Power Flow</span>
                        <span id="power-flow-status" class="status-value">Converged</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Voltage (Bus 2)</span>
                        <span id="bus-voltage" class="status-value">1.000 pu</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Reactive Power</span>
                        <span id="reactive-power" class="status-value">0.000 pu</span>
                    </div>
                    <div class="status-item" style="font-size: 0.8rem;">
                        <span class="status-label">Version</span>
                        <span id="build-version" class="status-value">__BUILD_VERSION__</span>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-container">
                <div class="chart-wrapper">
                    <canvas id="voltage-chart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="reactive-chart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="error-display"></div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboard-shortcuts-modal" class="keyboard-shortcuts-modal">
        <div class="keyboard-shortcuts-header">
            <h2>Keyboard Shortcuts</h2>
            <button id="keyboard-shortcuts-close" class="keyboard-shortcuts-close" title="Close">×</button>
        </div>
            
            <div class="shortcuts-section">
                <h3>Simulation Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Space</span>
                    </div>
                    <div class="shortcut-description">Start/Stop simulation</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Shift</span>
                        <span class="shortcut-key">Space</span>
                    </div>
                    <div class="shortcut-description">Reset simulation</div>
                </div>
            </div>

            <div class="shortcuts-section">
                <h3>Voltage Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">↑</span>
                    </div>
                    <div class="shortcut-description">Increase voltage (coarse adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">↓</span>
                    </div>
                    <div class="shortcut-description">Decrease voltage (coarse adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">→</span>
                    </div>
                    <div class="shortcut-description">Increase voltage (fine adjustment)</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">←</span>
                    </div>
                    <div class="shortcut-description">Decrease voltage (fine adjustment)</div>
                </div>
            </div>

            <div class="shortcuts-section">
                <h3>Interface Control</h3>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">?</span>
                    </div>
                    <div class="shortcut-description">Show keyboard shortcuts help</div>
                </div>
                <div class="shortcut-item">
                    <div class="shortcut-keys">
                        <span class="shortcut-key">Esc</span>
                    </div>
                    <div class="shortcut-description">Toggle sidebar (show/hide control panels)</div>
                </div>
            </div>
    </div>

    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Python code now loaded from separate files -->


    <!-- Status Panel Toggle Function -->
    <script>
        function toggleStatusPanel() {
            const content = document.getElementById('status-content');
            const toggle = document.getElementById('status-toggle');
            const controlPanel = content.closest('.control-panel');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlPanel.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlPanel.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleChartConfigPanel() {
            const content = document.getElementById('chart-config-content');
            const toggle = document.getElementById('chart-config-toggle');
            const controlPanel = content.closest('.control-panel');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlPanel.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlPanel.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleVoltageControlPanel() {
            const content = document.getElementById('voltage-control-content');
            const toggle = document.getElementById('voltage-control-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleSystemParametersPanel() {
            const content = document.getElementById('system-parameters-content');
            const toggle = document.getElementById('system-parameters-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleSimulationControlPanel() {
            const content = document.getElementById('simulation-control-content');
            const toggle = document.getElementById('simulation-control-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }

        function toggleTuningPanel() {
            const content = document.getElementById('tuning-content');
            const toggle = document.getElementById('tuning-toggle');
            const controlGroup = content.closest('.control-group');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                controlGroup.classList.remove('content-collapsed');
                toggle.innerHTML = '▼';
            } else {
                content.classList.add('collapsed');
                controlGroup.classList.add('content-collapsed');
                toggle.innerHTML = '▶';
            }
        }
    </script>
    
    <!-- Main JavaScript Application -->
    <script src="app.js"></script>
</body>
</html>